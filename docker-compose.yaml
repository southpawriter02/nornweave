name: nornweave

services:
  pgvector:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: nornweave
      POSTGRES_PASSWORD: nornweave_dev
      POSTGRES_DB: nornweave
    ports:
      - "5432:5432"
    volumes:
      - pgvector-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nornweave"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  kafka:
    image: bitnami/kafka:3.7
    environment:
      KAFKA_CFG_NODE_ID: "0"
      KAFKA_CFG_PROCESS_ROLES: broker,controller
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "0@kafka:9093"
      KAFKA_CFG_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093"
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT"
      KAFKA_CFG_ADVERTISED_LISTENERS: "PLAINTEXT://localhost:9092"
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "false"
    ports:
      - "9092:9092"
    volumes:
      - kafka-data:/bitnami/kafka
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  kafka-init:
    image: bitnami/kafka:3.7
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "Creating Kafka topics..."

        kafka-topics.sh --bootstrap-server kafka:9092 --create --if-not-exists \
          --topic nornweave.ingestion.events \
          --partitions 4 \
          --replication-factor 1 \
          --config retention.ms=604800000 \
          --config cleanup.policy=delete

        kafka-topics.sh --bootstrap-server kafka:9092 --create --if-not-exists \
          --topic nornweave.agent.lifecycle \
          --partitions 1 \
          --replication-factor 1 \
          --config retention.ms=259200000 \
          --config cleanup.policy=delete

        kafka-topics.sh --bootstrap-server kafka:9092 --create --if-not-exists \
          --topic nornweave.routing.feedback \
          --partitions 4 \
          --replication-factor 1 \
          --config retention.ms=604800000 \
          --config cleanup.policy=delete

        kafka-topics.sh --bootstrap-server kafka:9092 --create --if-not-exists \
          --topic nornweave.dlq \
          --partitions 1 \
          --replication-factor 1 \
          --config retention.ms=2592000000 \
          --config cleanup.policy=delete

        echo "All topics created."

volumes:
  pgvector-data:
  kafka-data:
